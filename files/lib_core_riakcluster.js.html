<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/core/riakcluster.js - basho-riak-client</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="basho-riak-client" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.4.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AuthReq.html">AuthReq</a></li>
                                <li><a href="../classes/Client.html">Client</a></li>
                                <li><a href="../classes/CommandBase.html">CommandBase</a></li>
                                <li><a href="../classes/DefaultNodeManager.html">DefaultNodeManager</a></li>
                                <li><a href="../classes/DeleteIndex.html">DeleteIndex</a></li>
                                <li><a href="../classes/DeleteIndex.Builder.html">DeleteIndex.Builder</a></li>
                                <li><a href="../classes/DeleteValue.html">DeleteValue</a></li>
                                <li><a href="../classes/DeleteValue.Builder.html">DeleteValue.Builder</a></li>
                                <li><a href="../classes/FetchBucketProps.html">FetchBucketProps</a></li>
                                <li><a href="../classes/FetchBucketProps.Builder.html">FetchBucketProps.Builder</a></li>
                                <li><a href="../classes/FetchCounter.html">FetchCounter</a></li>
                                <li><a href="../classes/FetchCounter.Builder.html">FetchCounter.Builder</a></li>
                                <li><a href="../classes/FetchIndex.html">FetchIndex</a></li>
                                <li><a href="../classes/FetchIndex.Builder.html">FetchIndex.Builder</a></li>
                                <li><a href="../classes/FetchMap.html">FetchMap</a></li>
                                <li><a href="../classes/FetchMap.Builder.html">FetchMap.Builder</a></li>
                                <li><a href="../classes/FetchPreflist.html">FetchPreflist</a></li>
                                <li><a href="../classes/FetchPreflist.Builder.html">FetchPreflist.Builder</a></li>
                                <li><a href="../classes/FetchSchema.html">FetchSchema</a></li>
                                <li><a href="../classes/FetchSchema.Builder.html">FetchSchema.Builder</a></li>
                                <li><a href="../classes/FetchSet.html">FetchSet</a></li>
                                <li><a href="../classes/FetchSet.Builder.html">FetchSet.Builder</a></li>
                                <li><a href="../classes/FetchValue.html">FetchValue</a></li>
                                <li><a href="../classes/FetchValue.Builder.html">FetchValue.Builder</a></li>
                                <li><a href="../classes/ListBuckets.html">ListBuckets</a></li>
                                <li><a href="../classes/ListBuckets.Builder.html">ListBuckets.Builder</a></li>
                                <li><a href="../classes/ListKeys.html">ListKeys</a></li>
                                <li><a href="../classes/ListKeys.Builder.html">ListKeys.Builder</a></li>
                                <li><a href="../classes/MapReduce.html">MapReduce</a></li>
                                <li><a href="../classes/NodeManager.html">NodeManager</a></li>
                                <li><a href="../classes/Ping.html">Ping</a></li>
                                <li><a href="../classes/RiakCluster.html">RiakCluster</a></li>
                                <li><a href="../classes/RiakCluster.Builder.html">RiakCluster.Builder</a></li>
                                <li><a href="../classes/RiakConnection.html">RiakConnection</a></li>
                                <li><a href="../classes/RiakNode.html">RiakNode</a></li>
                                <li><a href="../classes/RiakNode.Builder.html">RiakNode.Builder</a></li>
                                <li><a href="../classes/RiakObject.html">RiakObject</a></li>
                                <li><a href="../classes/Search.html">Search</a></li>
                                <li><a href="../classes/Search.Builder.html">Search.Builder</a></li>
                                <li><a href="../classes/SecondaryIndexQuery.html">SecondaryIndexQuery</a></li>
                                <li><a href="../classes/SecondaryIndexQuery.Builder.html">SecondaryIndexQuery.Builder</a></li>
                                <li><a href="../classes/StartTls.html">StartTls</a></li>
                                <li><a href="../classes/StoreBucketProps.html">StoreBucketProps</a></li>
                                <li><a href="../classes/StoreBucketProps.Builder.html">StoreBucketProps.Builder</a></li>
                                <li><a href="../classes/StoreIndex.html">StoreIndex</a></li>
                                <li><a href="../classes/StoreIndex.Builder.html">StoreIndex.Builder</a></li>
                                <li><a href="../classes/StoreSchema.html">StoreSchema</a></li>
                                <li><a href="../classes/StoreSchema.Builder.html">StoreSchema.Builder</a></li>
                                <li><a href="../classes/StoreValue.html">StoreValue</a></li>
                                <li><a href="../classes/StoreValue.Builder.html">StoreValue.Builder</a></li>
                                <li><a href="../classes/UpdateCounter.html">UpdateCounter</a></li>
                                <li><a href="../classes/UpdateCounter.Builder.html">UpdateCounter.Builder</a></li>
                                <li><a href="../classes/UpdateMap.html">UpdateMap</a></li>
                                <li><a href="../classes/UpdateMap.Builder.html">UpdateMap.Builder</a></li>
                                <li><a href="../classes/UpdateMap.MapOperation.html">UpdateMap.MapOperation</a></li>
                                <li><a href="../classes/UpdateSet.html">UpdateSet</a></li>
                                <li><a href="../classes/UpdateSet.Builder.html">UpdateSet.Builder</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Client.html">Client</a></li>
                                <li><a href="../modules/Core.html">Core</a></li>
                                <li><a href="../modules/CRDT.html">CRDT</a></li>
                                <li><a href="../modules/KV.html">KV</a></li>
                                <li><a href="../modules/MR.html">MR</a></li>
                                <li><a href="../modules/YZ.html">YZ</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: lib/core/riakcluster.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 * Copyright 2015 Basho Technologies, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

var RiakNode = require (&#x27;./riaknode&#x27;);
var DefaultNodeManager = require(&#x27;./defaultnodemanager&#x27;);
var events = require(&#x27;events&#x27;);
var logger = require(&#x27;winston&#x27;);
var Joi = require(&#x27;joi&#x27;);
var util = require(&#x27;util&#x27;);
var LinkedList = require(&#x27;linkedlist&#x27;);

/**
 * @module Core
 */

/**
 * Provides the RiakCluster class and its Builder.
 * 
 * Instances of this class maintain a set of {{#crossLink &quot;RiakNode&quot;}}{{/crossLink}} objects and 
 * executes commands on them.
 * 
 * __options__ is an object with the following defaults:
 * 
 *     {
 *       nodes: [defaultRiakNode],
 *       executionAttempts: 3,
 *       nodeManager: DefaultNodeManager,
 *       queueCommands: false,
 *       queueMaxDepth: unlimited
 *     }
 *     
 * The __defaultRiakNode__ is a RiakNode connected to 127.0.0.1:8087 
 * 
 * As a convenience a builder class is provided. 
 * 
 *     var nodeTemplate = new RiakNode.Builder().withMinConnections(10);
 *     var nodeAddys = [&#x27;192.168.1.1&#x27;, &#x27;192.168.1.2&#x27;];
 *     var arrayOfNodes = RiakNode.buildNodes(nodeAddys, nodeTemplate);
 *     var myCluster = new RiakCluster.Builder().withRiakNodes(arrayOfNodes).build();
 *     
 * See {{#crossLink &quot;RiakCluster.Builder&quot;}}RiakCluster.Builder{{/crossLink}}
 *
 * @class RiakCluster
 * @constructor
 * @param {Object} options - the options to use.
 * @param {RiakNode[]} options.nodes An array of (unstarted) {{#crossLink &quot;RiakNode&quot;}}{{/crossLink}} objects.
 * @param {Number} [options.executionAttempts=3] Number of times to retry commands on failure.
 * @param {Object} [options.nodeManager=DefaultNodeManager] Set the NodeManager for this cluster.
 * @param {Boolean} [options.queueCommands=false] Set whether to queue commands or not if no RiakNodes are available.
 * @param {Number} [options.queueMaxDepth=unlimited] The maximum number of commands to queue if queueCommands is set. Default is unlimited.
 * 
 */
function RiakCluster(options) {

    events.EventEmitter.call(this);
    var self = this;

    if (options === undefined) {
        options = {};
    }

    Joi.validate(options, schema, function(err, options) {
        if (err) {
            throw err;
        }

        self.nodes = options.nodes;
        self.executionAttempts = options.executionAttempts;
        self.state = State.CREATED;
        self.nodeManager = options.nodeManager;
        self.queueCommands = options.queueCommands;
        self.queueMaxDepth = options.queueMaxDepth;
    });

    this._commandQueue = new LinkedList();

}

util.inherits(RiakCluster, events.EventEmitter);

/**
 * Start this RiakCluster
 * @method start
 */
RiakCluster.prototype.start = function() {

    if (this._state === State.RUNNING) {
        logger.warning(&#x27;[RiakCluster] cluster already running.&#x27;);
    } else {
        this._stateCheck([State.CREATED]);
        logger.debug(&#x27;[RiakCluster] starting.&#x27;);

        for (var i = 0; i &lt; this.nodes.length; i++) {
            this._startNode(this.nodes[i]);
        }

        this.state = State.RUNNING;
        logger.debug(&#x27;[RiakCluster] cluster started.&#x27;);
        this.emit(EVT_SC, this.state);
    }

};

/**
 * Stop this RiakCluster
 * @method stop
 */
RiakCluster.prototype.stop = function() {

    this._stateCheck([State.RUNNING, State.QUEUEING]);

    logger.debug(&#x27;RiakCluster is shutting down&#x27;);

    this.state = State.SHUTTING_DOWN;
    this.emit(EVT_SC, this.state);

    for (var i = 0; i &lt; this.nodes.length; i++) {
        this.nodes[i].stop();
    }

    this._shutdown();

};

RiakCluster.prototype._startNode = function (node) {
    node.on(EVT_SC, this._onNodeStateChange.bind(this));
    node.on(EVT_RC, this._onRetryCommand.bind(this));
    node.start();
};

RiakCluster.prototype._shutdown = function () {

    logger.debug(&#x27;[RiakCluster] checking to see if nodes are shut down.&#x27;); 

    var allStopped = true;
    for (var i = 0; i &lt; this.nodes.length; i++) {
        if (this.nodes[i].state !== RiakNode.State.SHUTDOWN) {
            allStopped = false;
        }
    }

    if (allStopped) {
        this.state = State.SHUTDOWN;
        logger.debug(&#x27;[RiakCluster] cluster shut down.&#x27;);
        if (this._commandQueue.length) {
            logger.warn(&#x27;[RiakCluster] There were %d commands in the queue at shutdown&#x27;, 
                this._commandQueue.length);
        }
        this.emit(EVT_SC, this.state);
    } else {
        logger.debug(&#x27;[RiakCluster] nodes still running.&#x27;);
        var self = this;
        setTimeout(function() {
            self._shutdown();
        }, 1000);
    }

};

/**
 * Execute a command on this RiakCluster.
 * 
 * Selects a RiakNode from the cluster and executes the command on it.
 * @method execute
 * @param {Object} riakCommand - the command to execute.
 * @param {RiakNode} [previous] the previos node this command was attempted on
 */
RiakCluster.prototype.execute = function(riakCommand, previous) {

    // If there&#x27;s no previous node, set the remaining retries
    if (arguments.length === 1) {
        riakCommand.remainingTries = this.executionAttempts;
    }

    var executing = false;
    if (this._commandQueue.length === 0) {
        executing = this.nodeManager.executeOnNode(this.nodes, riakCommand, previous);
    }

    if (!executing) {
        if (this.queueCommands) {
            if (this.queueMaxDepth &amp;&amp; (this._commandQueue.length &gt;= this.queueMaxDepth)) {
                riakCommand.onError(&quot;No RiakNodes available and command queue at maxDepth&quot;);
            } else {
                this._commandQueue.push(riakCommand);
                if (this.state === State.RUNNING) {
                    this.state = State.QUEUEING;

                    // TODO: should this timeout be configurable, or based on an
                    // average command execution time?
                    setTimeout(this._submitFromQueue.bind(this), 500);
                    logger.info(&#x27;[RiakCluster] queueing commands.&#x27;);
                    this.emit(EVT_SC, this.state);
                }
            }
        } else {
            riakCommand.onError(&#x27;No RiakNodes available to execute command.&#x27;);
        }
    }

};

RiakCluster.prototype._submitFromQueue = function() {

    if (this.state &lt; State.SHUTTING_DOWN) {
        logger.debug(&#x27;[RiakCluster] submitFromQueue %d.&#x27;, this._commandQueue.length);
        var command;
        var executing;
        while (this._commandQueue.length) {
            command = this._commandQueue.shift();
            executing = this.nodeManager.executeOnNode(this.nodes, command);
            if (!executing) {
                this._commandQueue.unshift(command);
                // TODO: should this timeout be configurable, or based on an
                // average command execution time?
                setTimeout(this._submitFromQueue.bind(this), 500);
                break;
            }
        }

        if (!this._commandQueue.length) {
            this.state = State.RUNNING;
            logger.debug(&#x27;[RiakCluster] cleared command queue.&#x27;);
            this.emit(EVT_SC, this.state);
        }
    }

};

/**
 * Add a RiakNode ot this cluster.
 * @method addNode
 * @param {RiakNode} node the (unstarted) RiakNode to add.
 */
RiakCluster.prototype.addNode = function(node) {
    this._startNode(node);
    this.nodes.push(node);
};

/**
 * Remove a RiakNode from this cluster.
 * The node being removed will also be stopped.
 * @method removeNode
 * @param {RiakNode|String} node - the node to remove. May be supplied as a RiakNode instance or IP|hostname[:port]
 * @return {Boolean} - true if the node was removed.
 */
RiakCluster.prototype.removeNode = function(node) {

    for (var i = 0; i &lt; this.nodes.length; i++) {
        if (node instanceof RiakNode) {
            if (node === this.nodes[i]) {
                this.nodes.splice(i,1);
                node.stop();
                return true;
            }
        } else {
            // Hopefully it&#x27;s a string &quot;addr[:port]&quot;
            var split = node.split(&#x27;:&#x27;);
            if (this.nodes[i].remoteAddress === split[0]) {
                var removed;
                if (split.length === 2) {
                    if (this.nodes[i].remotePort === Number(split[1])) {
                        removed = this.nodes.splice(i,1);
                        removed[0].stop();
                        return true;
                    }
                } else {
                    removed = this.nodes.splice(i,1);
                    removed[0].stop();
                    return true;
                }
            }
        }
    }

    return false;

};

RiakCluster.prototype._onNodeStateChange = function(node, state) {
    this.emit(EVT_NSC, node, state);
};

RiakCluster.prototype._onRetryCommand = function(command, lastNode) {
    this.execute(command, lastNode);
};

RiakCluster.prototype._stateCheck = function(allowedStates) {
    if (allowedStates.indexOf(this.state) === -1) {
        throw &#x27;RiakCluster: Illegal State; required: &#x27; + allowedStates + &#x27; current: &#x27; + this.state; 
    }
};

/**
 * The state of this cluster.
 * 
 * If listeneing for stateChange events, a numeric value will be sent that
 * can be compared to:
 * 
 *     RiakCluster.State.CREATED
 *     RiakCluster.State.RUNNING
 *     RiakCluster.State.SHUTTING_DOWN
 *     RiakCluster.State.SHUTDOWN
 * 
 * See: {{#crossLink &quot;RiakCluster/stateChange:event&quot;}}stateChange{{/crossLink}}
 * 
 * @property State
 * @type {Object}
 * @static
 * @final
 */
var State = Object.freeze({ CREATED : 0, 
                            RUNNING : 1,
                            QUEUEING: 2, 
                            SHUTTING_DOWN : 3, 
                            SHUTDOWN : 4});

var defaultRiakNode = new RiakNode();
var defaultExecutionAttempts = 3;

function createDefaultNodeManager() {
    return new DefaultNodeManager();
}

var schema = Joi.object().keys({
    nodes: Joi.array().min(1).default([defaultRiakNode]),
    executionAttempts: Joi.number().min(1).default(defaultExecutionAttempts),
    nodeManager: Joi.object()
        .default(createDefaultNodeManager, &#x27;default is a new instance of DefaultNodeManager&#x27;),
    queueCommands: Joi.boolean().default(false),
    queueMaxDepth: Joi.number().default(0)
});

/**
 * This event is fired when the state of the RiakCluster changes.
 * See: {{#crossLink &quot;RiakCluster/State:property&quot;}}RiakCluster.State{{/crossLink}}
 * @event stateChange
 * @param {Number} state - the new {{#crossLink &quot;RiakCluster/State:property&quot;}}RiakCluster.State{{/crossLink}}
 */
var EVT_SC = &#x27;stateChange&#x27;;

/**
 * This event is fired when the state of any RiakNode in the cluster changes.
 * @event nodeStateChange
 * @param {Object} node - the {{#crossLink &quot;RiakNode&quot;}}{{/crossLink}} object whose state changed
 * @param {Number} state - the {{#crossLink &quot;RiakNode/State:property&quot;}}RiakNode.State{{/crossLink}}
 */
var EVT_NSC = &#x27;nodeStateChange&#x27;;

/**
 * This event is fired whenever a command fails on a RiakNode and needs to be retried.
 * RiakCluster is a listener.
 */
var EVT_RC = &#x27;retryCommand&#x27;;

/**
 * A Builder for constructing RiakCluster instances.
 * 
 * Rather than having to manually construct the __options__ and instantiating
 * a RiakCluster directly, this builder may be used.
 * 
 * var newCluster = new RiakCluster.Builder().withRiakNodes([node1, node2]).build();
 * 
 * @class RiakCluster.Builder
 * @constructor
 */
function Builder() {
    this.nodes = [];
}

Builder.prototype = {
    /**
     * The RiakNodes to use.
     * @method withRiakNodes
     * @param {RiakNode[]} nodes array of (unstarted) {{#crossLink &quot;RiakNode&quot;}}{{/crossLink}} instances.
     * @return {RiakCluster.Builder}
     */
    withRiakNodes : function(nodes) {
        for (var i = 0; i &lt; nodes.length; i++) {
            if (nodes[i] instanceof RiakNode) {
                this.nodes.push(nodes[i]); 
            }
        }
        return this;
    },
    /**
     * Set the number of times a command will be attempted.
     * In the case of a command failing for any reason, it will be retied 
     * on a different node. 
     * @method withExecutionAttempts
     * @param {Number} numAttempts - the number of times to attempt a command (__default:__ 3)
     * @return {RiakCluster.Builder}
     */
    withExecutionAttmpts : function(numAttempts) {
        this.executionAttempts = numAttempts;
        return this;
    },
    /**
     * Set the NodeManager for this cluster.
     * 
     * If not provided the {{#crossLink &quot;DefaultNodeManager&quot;}}{{/crossLink}} is
     * used.
     * @method withNodeManager
     * @param {NodeManager} nodeManager the node manager used to select nodes.
     * @chainable
     */
    withNodeManager : function(nodeManager) {
        this.nodeManager = nodeManager;
        return this;
    },
    /**
     * Set whether to queue commands or not if no RiakNodes are available.
     * 
     * If all nodes are down (health checking) or maxConnections are in use on
     * all nodes, the default behavior is to fail commands when submitted. 
     * 
     * Setting this option causes the the RiakCluster to queue additional commands
     * (FIFO) then send them when nodes/connections become available. 
     * 
     * If maxDepth is supplied the queue is bounded and additional commands 
     * attempting to be queued will be failed. The default is an unbounded queue.
     * 
     * @method withQueueCommands
     * @param {Number} [maxDepth=unlimited] the maximum number of commands to queue. Default is unlimited.
     * @chainable
     */
    withQueueCommands : function(maxDepth) {
        this.queueCommands = true;
        this.queueMaxDepth = maxDepth;
        return this;
    },
    /**
     * Builds a RiakCluster instance.
     * @method build
     * @return {RiakCluster}
     */
    build : function() {
        return new RiakCluster(this);
    }
};

module.exports = RiakCluster;
module.exports.Builder = Builder;
module.exports.State = State;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
